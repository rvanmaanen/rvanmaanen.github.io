<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>How to make two VM extensions depend on each other in ARM | r-vm.com</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="How to make two VM extensions depend on each other in ARM" />
<meta name="author" content="Reinier van Maanen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How I fixed my Chocolatey Server ARM template by using DSC and a custom script extension that depend on each other" />
<meta property="og:description" content="How I fixed my Chocolatey Server ARM template by using DSC and a custom script extension that depend on each other" />
<link rel="canonical" href="https://r-vm.com/depend-on-multiple-arm-script-extensions" />
<meta property="og:url" content="https://r-vm.com/depend-on-multiple-arm-script-extensions" />
<meta property="og:site_name" content="r-vm.com" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-02T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"How I fixed my Chocolatey Server ARM template by using DSC and a custom script extension that depend on each other","author":{"@type":"Person","name":"Reinier van Maanen"},"@type":"BlogPosting","url":"https://r-vm.com/depend-on-multiple-arm-script-extensions","headline":"How to make two VM extensions depend on each other in ARM","dateModified":"2018-08-02T00:00:00+02:00","datePublished":"2018-08-02T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://r-vm.com/depend-on-multiple-arm-script-extensions"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://r-vm.com/feed.xml" title="r-vm.com" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">r-vm.com</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to make two VM extensions depend on each other in ARM</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-08-02T00:00:00+02:00" itemprop="datePublished">Aug 2, 2018
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Recently I helped <a href="https://rajbos.github.io/">Rob Bos</a> by creating an ARM template, that allowed him to spin up a VM in Azure and which would host a Chocolatey Server. Rob wrote <a href="https://rajbos.github.io/blog/2018/07/20/chocolatey-server-azure">a nice blog post</a> about this. As he mentions in his post, there are still some issues with the ARM template. On major thing is fixed though: The DSC step no longer fails and it’s no longer necessary to manually execute PowerShell. Here’s how I fixed it.<!--excerpt_end--></p>

<p style="text-align: center;"><img src="https://r-vm.com/assets/multiple_vm_extensions/msazure.png" alt="Microsoft Azure" /></p>

<h1 id="how-to-make-powershelldscextension-and-customscriptextension-depend-on-each-other-in-arm">How to make PowershellDscExtension and CustomScriptExtension depend on each other in ARM</h1>
<ol>
  <li>Add the VM and both extensions to your ARM template and give them proper names.</li>
  <li>Create the dependsOn element at the CustomScriptExtension and follow the next steps to determine what to fill in here.</li>
  <li>Take the type and name of the VM your extensions will run on, in the example below that would be: “Microsoft.Compute/virtualMachines/ChocolateyServer”</li>
  <li>Add /extensions and then /name-of-the-extension-you-depend-on, so that would be: “Microsoft.Compute/virtualMachines/ChocolateyServer/extensions/NeverGonna”</li>
  <li>Enjoy your dependency! If you need any more help, have a look at the example below or reach out!</li>
</ol>

<p>So the key thing is: you’re not depending on something by just it’s name, you’re depending on the (end of the) resource identifier. An easy way to find this identifier is by going to the <a href="https://resources.azure.com">Azure resource explorer</a>, which gives you a nice view of all the resources in your subscriptions. Just add the DSC first, then check out the identifier and then add the script.</p>

<p>Something to watch out for is that my extensions were actually named: “ChocServ/PowershellDscExtension” and “ChocServ/CustomScriptExtension”. However, only the latter part was used in my resource identifiers. So in my dependsOn I needed to leave out the “ChocServ/” part. Again, have a look at the <a href="https://resources.azure.com">Azure resource explorer</a> to find out the exact identifier.</p>

<h1 id="it-should-look-something-like-this">It should look something like this</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    {
      "type": "Microsoft.Compute/virtualMachines",
      "name": ChocolateyServer",
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "NeverGonna",
      "dependsOn": [
        "Microsoft.Compute/virtualMachines/ChocolateyServer"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "GiveYouUp",
      "dependsOn": [
        "Microsoft.Compute/virtualMachines/ChocolateyServer/extensions/NeverGonna"
      ]
    }
</code></pre></div></div>

<h1 id="nice-so-now-i-can-have-multiple-scripts-depending-on-each-other">Nice! So now I can have multiple scripts depending on each other?</h1>
<p>Nope. One thing I learned while fixing my ARM template, is that you can’t have multiple PowershellDscExtension or multiple CustomScriptExtension in one ARM template. Not sure why. You can have a single one of both though. So if you came here looking how to execute multiple PowerShell scripts, you’re looking in the wrong place. There are ways to do that though and <a href="https://stackoverflow.com/questions/36372049/how-to-run-multiple-powershell-scripts-at-the-same-time">here’s a starting point</a>.</p>

<h1 id="remaining-issues-in-the-chocolatey-server-arm-template">Remaining issues in the Chocolatey Server ARM template</h1>
<p>There are some small remaining issues with the ARM template, <a href="https://github.com/rvanmaanen/arm.chocolateyserver/issues">which you can see here</a>. Feel free to submit a pull request or add new issues if you have any. I’ll try and fix them. You can also find the ChocolateyServer ARM template there.</p>

  </div><a class="u-url" href="/depend-on-multiple-arm-script-extensions" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">
            Reinier van Maanen
            </li><li><a class="u-email" href="mailto:rvanmaanen@xpirit.com">rvanmaanen@xpirit.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-3"><ul class="social-media-list"><li><a href="https://github.com/rvanmaanen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">rvanmaanen</span></a></li><li><a href="https://www.linkedin.com/in/reiniervanmaanen"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">reiniervanmaanen</span></a></li><li><a href="https://www.twitter.com/maanenreinier"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">maanenreinier</span></a></li></ul>
</div>

      <div class="footer-col footer-col-2">
        <p>A blog about anything related to my work, mostly stuff I did or had to Google myself, hope it helps someone else!</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>